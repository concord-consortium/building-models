# SageModeler External API Implementation Plan

## 1. Comprehensive Backlog

The following PBIs (Product Backlog Items) cover all features of the SageModeler External API. Each PBI is expressed as a user story with acceptance criteria.

| ID | Actor                 | User Story                                                                                                                                                                                                                                            | Status   | Conditions of Satisfaction (CoS)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- | --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1  | Plugin Developer      | **As a plugin developer**, I want to **programmatically create, modify, and remove elements of a SageModeler model (nodes and links)**, and to **retrieve or replace the entire model**, so that I can **build or edit models without manual input**. | InProgress | Supports API commands to create new nodes and links, update node/link properties, delete nodes/links, get the full current model, and load a model JSON; each command returns a success acknowledgment or error; changes are immediately reflected in the SageModeler UI.                                                                                                                                                                                                                                                   |
| 2  | Plugin Developer      | **As a plugin developer**, I want to **run a SageModeler simulation via the API with optional parameters**, so that I can **execute the model and obtain results programmatically**.                                                                  | Proposed | An API call can start the model's simulation (with optional duration/step settings); SageModeler returns an immediate confirmation (success or failure) for the run request; the simulation runs to completion as if triggered by the UI; simulation milestones (start and end) are communicated back to plugins (e.g. via events).                                                                                                                                                                                         |
| 3  | Plugin Developer      | **As a plugin developer**, I want to **receive real-time events for all model changes and simulation progress**, so that my plugin can **react when the SageModeler model is edited or a simulation completes**.                                      | Proposed | SageModeler broadcasts an event message for every model change (node/link created, deleted, updated) and for simulation start/completion; events include relevant details (e.g. IDs, values) and indicate the source as SageModeler; events are delivered to all CODAP plugins in a standard format; high-frequency events (e.g. rapid value changes) are throttled to avoid flooding.                                                                                                                                      |
| 4  | Plugin Developer      | **As a plugin developer**, I want **SageModeler to accept and handle external API messages** (tagged "sageApi"), executing the specified commands and replying with success or error, so that I can **control SageModeler reliably via script**.    | Proposed | The SageModeler iframe listens for incoming "sageApi" messages from the CODAP parent; any valid API request (create, update, delete, etc.) is executed atomically in the SageModeler model, without requiring user interaction; each request yields a response message (with matching requestId) indicating success or failure (with error info on failure); malformed or unauthorized messages are ignored or result in error responses.                                                                                   |
| 5  | Plugin Developer      | **As a plugin developer**, I want to **import and export SageModeler models in both the native format and a standard SD-JSON format**, so that I can **interoperate with other modeling tools (e.g. AI assistants)**.                                 | Proposed | The API supports exporting the current model as JSON in SageModeler's native schema or in the standard SD-JSON schema (per request parameter); the API supports loading a model into SageModeler from either a native JSON or SD-JSON input; when using SD-JSON, unsupported constructs (e.g. flows or equations beyond SageModeler's scope) are handled gracefully (ignored with warnings) without preventing import; imported models and exported models maintain fidelity for all supported elements.                    |
| 6  | SageModeler Developer | **As a SageModeler developer**, I want the external API to be **secure, robust, and observable**, with input validation, concurrency safety, and logging, so that it can be **safely deployed and debugged in real classroom settings**.              | Proposed | All incoming API messages are validated against a schema and rejected if malformed; invalid operations (e.g. commands during a running simulation) are prevented with appropriate error responses; only frames launched by CODAP can send API messages; a "busy" state prevents concurrent simulations or model edits during simulation runs; a debug mode is available to log API activity, while normal operation logs only warnings/errors; basic usage metrics (API calls, errors, events) are tracked for diagnostics. |
| 7  | Plugin Developer      | **As a plugin developer**, I want to **read and modify SageModeler's global model settings (e.g., simulation type, time units, step size, display options) via the API**, so that I can fully automate and configure models programmatically, achieving parity with the settings menu. | Proposed | API provides endpoints to get and set all global model settings available in the UI; supported settings include simulation type (if applicable), time units, step size, and other relevant options; changes via API are reflected in the UI and model state; invalid or unsupported settings are rejected with clear error messages; all changes are undoable/redone via the API (if feasible). |
| 8  | Plugin Developer      | **As a plugin developer**, I want to **explicitly create flow nodes and have them auto-generated when needed (e.g., when linking accumulators) via the API**, so that programmatic model construction matches all user affordances and produces valid, runnable models. | Proposed | API provides an explicit command to create a flow node, with all relevant properties; API supports auto-generation of flow nodes during link creation, matching UI logic; API responses include IDs of all created nodes/links; all operations are undoable/redone via the API (if feasible); behavior is documented and matches UI affordances; edge cases (e.g., repeated links, manual flow creation) are handled gracefully. |