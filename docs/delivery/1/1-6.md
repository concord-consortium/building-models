#### Task 1-6: Implement Delete Link API Command

##### Description

Implement the API operation to remove an existing link from the model. This corresponds to `action:"delete"` on a `resource:"links/{id}"`. Removing a link via API should be equivalent to the user deleting a link in the UI: the causal relationship is removed, and any related data in the simulation (like if that link was the only input to a node, might affect something) is handled internally.

##### Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
| :---- | :---- | :---- | :---- | :---- | :---- |
| 2025-06-22 17:35:00 | Created | N/A | Proposed | Task drafted (PBI-1) | Chad |

##### Requirements

* Detect a delete-link message (`action:"delete", resource:"links/{id}"`).  
    
* Validate existence of the link with that ID. If not found, return error.  
    
* Use **GraphStore** to remove the link. GraphStore provides `removeLink(link, options)`. But it expects a Link object or link instance. Alternatively, GraphStore also has `removeSelectedLinks()` or `deleteSelected()`, but those operate on UI selection. We should use `removeLink`.  
    
  * If we have the link ID, we can retrieve `const link = GraphStore.linkKeys[id]`. If found, call `GraphStore.removeLink(link, { logEvent:true })`. This should remove the link from internal state and call `_graphUpdated` etc. GraphStore.removeLink will likely simply do the removal and if logEvent logs "relationship deleted".  
  * We should double-check: GraphStore.removeLink signature is `removeLink(link: Link, options?: LogOptions): void`. It likely uses link.key for removal and possibly updates CODAP if needed (though removing a link usually doesn’t affect CODAP data unless it’s a flow variable link scenario – but then a flow node might be removed if it became orphan, not sure). GraphStore likely just splices it out and triggers updateListeners.


* No special side effects expected except UI update (arrow disappears). If the link had a "flow variable" intermediate node, GraphStore might handle that upstream; but deletion of a link probably doesn’t auto-delete any nodes, except if it was a transfer link that, when removed, triggers some cleanup – but GraphStore might handle in `changeNode` in other context. Removing a normal link between two variables is straightforward.  
    
* Construct response: `success:true` and perhaps confirming the link id.  
    
* If link not found \-\> `success:false`.  
    
* Ensure atomic (if link doesn’t exist, nothing changes).  
    
* Ensure that after removal, the model’s link count is decremented and UI reflects removal.

##### Implementation Plan

1. Add handling for `action:"delete", resource:"links/{id}"` to call `handleDeleteLink(linkId)`.  
2. Find the link: `const link = GraphStore.linkKeys[linkId]`. If undefined, return error response "Link not found".  
3. If found, call `GraphStore.removeLink(link, { logEvent:true })`. We expect this to remove the link from GraphStore.linkKeys and update UI (via updateListeners). Surround with try/catch just in case.  
4. On success, form response success (maybe `{ id: linkId }` in data).  
5. There might be an edge-case: If the link is a special "flow link" connecting to a transfer node, GraphStore.removeLink will remove it and probably leave the transfer node orphan. In UI, when user deletes a flow link, they might also auto-delete the flow node. GraphStore may detect that: after removeLink, one could check `GraphStore.allLinksAreUndefined()` or see if a transfer node should be removed. There is `removeLinksForNode(node)` method if needed. But we won't handle explicitly – if an orphan transfer node remains, it might still appear. Possibly GraphStore’s logic in changeNode or something covers it. However, that scenario is rarer. We'll not complicate; the teacher or plugin could remove that node separately if needed. Document such nuance if necessary.  
6. **Testing**: Confirm link removal worked (see verification).

##### Verification

* **Unit Test**: Create two nodes and a link between them. Then send delete link for that link’s id. Assert:  
    
  * Response success.  
  * `GraphStore.linkKeys` no longer contains that id.  
  * Total links count decreased by 1\.  
  * The nodes that were connected now show no connection (if Node has a property like node.outLinks, verify that link is gone). Possibly GraphStore.getLinks() returns one less entry.  
  * Removing a link should not affect nodes list. Confirm node count unchanged.


* **Invalid ID**: Try deleting an ID not in linkKeys \-\> error response, and no change to links.  
    
* **Integration**: In SageModeler UI, create a link between two nodes. Then via plugin call delete-link for that link’s id. Verify the arrow connecting them disappears. The plugin should get a success response. If that link was the only link to/from a particular node, the node remains but now isolated (which is fine). If the link was part of a cycle, the cycle is broken, etc. All as expected.  
    
* (If applicable, test with a model that has a flow variable: deleting a flow link possibly leaves the flow node on canvas with no effect – the UI might require user to delete it manually. Our API likewise would not auto-delete that intermediate node, which is acceptable; the plugin can delete it via node deletion if needed. We might mention this scenario in documentation rather than test it extensively, as it's an advanced case.)

##### Files Modified

* `src/code/sage-api.ts` – Implement `handleDeleteLink`.  
* No direct changes to others.  
* Possibly double-check if GraphStore requires a particular way to reference the link: removeLink expects a Link object, which we provide. (We should be careful not to pass an ID or anything; passing the actual Link instance as we retrieve is correct.)